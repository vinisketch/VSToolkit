define(["exports","vs_utils","vs_core"],function(t,e,i){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,i=i&&i.hasOwnProperty("default")?i.default:i;var r=function(t){this.parent=i.EventSource,this.parent(t),this.constructor=r,r.loadService(this),this.ERROR_CODE=0,this._addresses=[],this._position=[]};r.loadService=function(t){if(!r.__google_loaded__){if(!r.__google_wait_loaded__){r.__google_wait_loaded__=!0;var i="http://www.google.com/jsapi?key="+r.key+"&callback=vs.data.GoogleSearch.__on_loaded";e.importFile(i,null,null,"js")}t&&r._to_finish_init.push(t)}},r.key=" ABQIAAAAE4BGaIh0t-7l9PDR7PA0rRR6KW34AlT62yZeC298tyhOjAL-9hQQpk22pW6ZfaCFEr3zjz2Q8rjqAw",r.__google_wait_loaded__=!1,r.__google_loaded__=!1,r._to_finish_init=new Array,r.LOCAL_SEARCH_ENGINE=1,r.VIDEO_SEARCH_ENGINE=2,r.__on_loaded=function(){google.load("search","1",{nocss:!0,callback:vs.data.GoogleSearch.__on_search_loaded})},r.__on_search_loaded=function(){var t,e;for(r.__google_loaded__=!0,r.__google_wait_loaded__=!1,t=0,e=r._to_finish_init.length;t<e;t++)r._to_finish_init[t].finishInit();r._to_finish_init=null},r.ERROR_CODE_STR=["No error","Unknown error","Unvalid parameters data","Error with google server","Connexion error","Unvalid google response"],r.prototype={__local_search:void 0,__video_search:void 0,__init_ok:!1,__engine_to_init:0,__end_init_clb:null,_engine_loaded:!1,_str_address:"",_addresses:null,_position:null,finishInit:function(){this.__init_ok=!0,this.__engine_to_init&&(this.setSearchEngine(this.__engine_to_init),this.__engine_to_init=0)},setSearchEngine:function(t){this.__init_ok?(t|r.LOCAL_SEARCH_ENGINE&&!this.__local_search&&(this.__local_search=new google.search.LocalSearch,this.__local_search.setResultSetSize(google.search.Search.SMALL_RESULTSET),this.__local_search.setNoHtmlGeneration()),t|r.VIDEO_SEARCH_ENGINE&&!this.__video_search&&(this.__video_search=new google.search.VideoSearch,this.__video_search.setResultSetSize(google.search.Search.SMALL_RESULTSET),this.__video_search.setNoHtmlGeneration()),this._engine_loaded=!0,this.propagate("engineload"),this.outPropertyChange("engineLoaded")):this.__engine_to_init=t},_newGoogleLocalSearch:function(t,e){var i=this;if(this.__local_search.setSearchCompleteCallback(this,function(){e.call(i,i.__local_search.results)}),!t||"string"!=typeof t)return this.ERROR_CODE=2,void e.call(i,null);this.__local_search.execute(t)},_googleLocalSearch:function(t,e){if(this.__local_search)this._newGoogleLocalSearch(t,e);else{if(!t||"string"!=typeof t)return this.ERROR_CODE=2,void e.call(this,null);var i="http://ajax.googleapis.com/ajax/services/search/local?v=1.0&q="+t,r=new XMLHttpRequest;if(r.open("GET",i,!1),r.send(null),4===r.readyState){var n=JSON.parse(r.responseText);return 200!==n.responseStatus?(this.ERROR_CODE=3,void e.call(this,null)):n.responseData?void e.call(this,n.responseData):(this.ERROR_CODE=5,void e.call(this,null))}this.ERROR_CODE=4,e.call(this,null)}},GPSCoordinateToAddress:function(t,e,i){if(this.__local_search){if(i||(i=this),!t||!t.length)return this.ERROR_CODE=2,void e.call(i,null);var r=t[0]+","+t[1],n=this;this._googleLocalSearch(r,function(t){if(!t)return this.ERROR_CODE=5,void e.call(i,null);if(0===t.length||!t[0])return this.ERROR_CODE=5,void e.call(i,null);n._addresses=[];var r={title:"",addressLine:"",streetAddress:"",city:"",region:"",country_code:"",postalCode:0};r.title=t[0].titleNoFormatting,r.addressLine=t[0].addressLines.join(", "),r.streetAddress=t[0].streetAddress,r.city=t[0].city,r.region=t[0].region,r.country_code=t[0].country,r.postalCode=t[0].postalCode,r.locale=n.countryToLocal(r.country_code),n._addresses.push(r),e.call(i,r),n.outPropertyChange("addresses")})}else console.error("The local search engine is not initialized")},countryToLocal:function(t){switch(t){case"US":return"en_US";case"GB":return"en_GB";case"FR":return"fr_FR";case"CA":return"fr_CA";case void 0:return"en_US";default:return t.toLowerCase()}},addressToGPSCoordinate:function(t,e,i){if(this.__local_search){var r=[0,0];if(i||(i=this),!t||"string"!=typeof t)return this.ERROR_CODE=2,void e.call(i,null);var n='"'+t+'"',s=this;this._googleLocalSearch(n,function(t){if(t){if(!t[0])return this.ERROR_CODE=5,void e.call(i,null);r[0]=parseFloat(t[0].lat),r[1]=parseFloat(t[0].lng),s._position=r,e.call(i,r.slice()),s.outPropertyChange("position")}})}else console.error("The local search engine is not initialized")},searchAddress:function(t,e,i){if(this.__local_search){if(i||(i=this),!t||"string"!=typeof t)return this.ERROR_CODE=2,void e.call(i,null);var r='"'+t+'"',n=this;this._googleLocalSearch(r,function(t){if(n._addresses=[],!t)return e.call(i,[]),void n.outPropertyChange("addresses");for(var r=0;r<t.length;r++){var s={};s.title=t[r].titleNoFormatting,s.addressLine=t[r].addressLines.join(", "),s.streetAddress=t[r].streetAddress,s.city=t[r].city,s.region=t[r].region,s.country_code=t[r].country,s.postalCode=t[r].postalCode,n._addresses.push(s)}e.call(i,n._addresses.slice()),n.outPropertyChange("addresses")})}else console.error("The local search engine is not initialized")}},e.extendClass(r,i.EventSource),e.defineClassProperties(r,{strAddress:{set:function(t){if(e.isString(t)){this._str_address=t;var i=this;this.searchAddress(t,function(e){i.addressToGPSCoordinate(t,function(t){},this)},this)}}},addresses:{get:function(t){return this._addresses}},position:{set:function(t){e.isArray(t)&&2===t.length&&e.isNumber(t[0])&&e.isNumber(t[1])&&this.GPSCoordinateToAddress(t,function(t){},this)},get:function(){return this._position}},engineLoaded:{get:function(){return this._engine_loaded}}});function n(t){this.parent=i.VSObject,this.parent(t),this.constructor=n}n.prototype={_src:"",_anchor:"",_query:"",_file:"",_directory:"",_path:"",_relative:"",_port:0,_host:"",_password:"",_user:"",_authority:"",_protocol:"",_query_key:null,__options:{strictMode:!1,key:["_source","_protocol","_authority","_userInfo","_user","_password","_host","_port","_relative","_path","_directory","_file","_query","_anchor"],q:{name:"_query_key",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},parse:function(t){if(e.isString(t)){this._src=t;for(var i=this.__options,r=i.parser[i.strictMode?"strict":"loose"].exec(t),n=14,s=this;n--;)this[i.key[n]]=r[n]||"";this[i.q.name]={},this[i.key[12]].replace(i.q.parser,function(t,e,r){e&&(s[i.q.name][e]=r)}),this.outPropertyChange("src")}}},e.extendClass(n,i.VSObject),e.defineClassProperties(n,{src:{set:function(t){e.isString(t)&&this.parse(t)},get:function(){return this._src}},anchor:{get:function(){return this._anchor}},query:{get:function(){return this._query}},queryKey:{get:function(){return this._query_key}},file:{get:function(){return this._file}},directory:{get:function(){return this._directory}},path:{get:function(){return this._path}},port:{get:function(){return this._port}},relative:{get:function(){return this._relative}},host:{get:function(){return this._host}},password:{get:function(){return this._password}},user:{get:function(){return this._user}},authority:{get:function(){return this._authority}},protocol:{get:function(){return this._protocol}}});function s(t){for(var e=["title","link","description","author","comments","pubDate"],i=["_title","_link","_description","_author","_comments","_pub_date"],r=null,n=0;n<e.length;n++)(r=t.getElementsByTagName(e[n])[0])&&(this[i[n]]=r.textContent);this._category=new o(t.getElementsByTagName("category")[0]),this._enclosure=new function(t){t?(this.url=t.getAttribute("url"),this.length=t.getAttribute("length"),this.type=t.getAttribute("type")):(this.url=null,this.length=null,this.type=null)}(t.getElementsByTagName("enclosure")[0]),this._guid=new function(t){t?(this.isPermaLink=t.getAttribute("isPermaLink"),this.value=t.textContent):(this.isPermaLink=null,this.value=null)}(t.getElementsByTagName("guid")[0]),this._source=new function(t){t?(this.url=t.getAttribute("url"),this.value=t.textContent):(this.url=null,this.value=null)}(t.getElementsByTagName("source")[0]),this._image=new a(t.getElementsByTagName("content")[0]),this._image&&(this._image_url=this.image.url)}s.prototype={_title:"",_link:"",_description:"",_author:"",_comments:"",_pub_date:"",_category:null,_enclosure:null,_guid:null,_source:null,_image:null,_image_url:"",_category:null,toString:function(){return this.title}},e.defineClassProperties(s,{title:{get:function(){return this._title}},link:{get:function(){return this._link}},description:{get:function(){return this._description}},author:{get:function(){return this._author}},comments:{get:function(){return this._comments}},pubDate:{get:function(){return this._pub_date}},category:{get:function(){return this._category}},enclosure:{get:function(){return this._enclosure}},guid:{get:function(){return this._guid}},source:{get:function(){return this._source}},image:{get:function(){return this._image}},imageUrl:{get:function(){return this._image_url}}});function o(t){t?(this.domain=t.getAttribute("domain"),this.value=t.textContent):(this.domain=null,this.value=null)}function a(t){if(t){imgAttribs=["url","title","link","width","height","description"];for(var e=0;e<imgAttribs.length;e++)t.getAttribute(imgAttribs[e])&&(this[imgAttribs[e]]=t.getAttribute(imgAttribs[e]))}else this.url=null,this.link=null,this.width=null,this.height=null,this.description=null}var l=function(t){this.parent=i.EventSource,this.parent(t),this.constructor=l};l.prototype={_items:null,_title:null,_link:null,_description:null,_language:null,_copyright:null,_managing_editor:null,_web_master:null,_pub_date:null,_last_build_date:null,_generator:null,_docs:null,_ttl:null,_rating:null},e.extendClass(l,i.EventSource),e.defineClassProperties(l,{items:{get:function(){return this._items}},title:{get:function(){return this._title}},link:{get:function(){return this._link}},description:{get:function(){return this._description}},language:{get:function(){return this._language}},copyright:{get:function(){return this._copyright}},managingEditor:{get:function(){return this._managing_editor}},webMaster:{get:function(){return this._web_master}},pubDate:{get:function(){return this._pub_date}},lastBuildDate:{get:function(){return this._last_build_date}},generator:{get:function(){return this._generator}},docs:{get:function(){return this._docs}},rating:{get:function(){return this._rating}},image:{get:function(){return this._image}},imageUrl:{get:function(){return this._image_url}},category:{get:function(){return this._category}}});var _=function(t){this.parent=l,this.parent(t),this.constructor=_,this._rss=this};_.prototype={_url:"",_rss:null,initComponent:function(){l.prototype.initComponent.call(this),this._xhr=new i.HTTPRequest,this._xhr.init(),this._xhr.bind("xmlload",this,this.processRSS),this._xhr.bind("loaderror",this,this.processError)},destructor:function(){this._xhr.unbind("xmlload",this,this.processRSS),this._xhr.unbind("loaderror",this,this.processError),free(this._xhr),l.prototype.destructor.call(this)},loadRSS:function(){this._xhr.send()},processRSS:function(t){var e=t.data;if(!e&&!(e=(new DOMParser).parseFromString(this._xhr.responseText,"application/xml")))return console.error("Failed to parse rss document that is null."),this.propagate("rssloaderror","document null."),!1;!function(t,e){if(t._items=[],!e)return console.error("Failed to parse rss document that is null."),!1;for(var i=e.getElementsByTagName("channel")[0],r=e.getElementsByTagName("item"),n=0;n<r.length;n++)Item=new s(r[n]),t._items.push(Item);var l=["_title","_link","_description","_language","_copyright","_managing_editor","_web_master","_pub_date","_last_build_date","_generator","_docs","_ttl","_rating"],_=["title","link","description","language","copyright","managingEditor","webMaster","pubDate","lastBuildDate","generator","docs","ttl","rating"],u=null;for(n=0;n<_.length;n++)(u=i.getElementsByTagName(_[n])[0])&&(t[l[n]]=u.textContent);t._category=new o(i.getElementsByTagName("category")[0]),t._image=new a(i.getElementsByTagName("image")[0])}(this,e),this.propagate("rssload",this),this.outPropertyChange()},processError:function(t){t&&t.data&&"failed"===t.data.status&&this.performAlternateRequest?this.performAlternateRequest():this.propagate("rssloaderror")},propertiesDidChange:function(){return this.loadRSS(),!0},performAlternateRequest:function(){var t=(new i.AjaxJSONP).init();t.url="http://pipes.yahoo.com/pipes/pipe.run?_id=9oyONQzA2xGOkM4FqGIyXQ&_render=json&feed="+escape(this._url),t.clbParamName="_callback",t.bind("jsonload",this,function(t){var e=t.data;if(e&&e.value&&e.value.items){var i=e.value;this._pub_date=i.pubDate,this._items=[],itemElements=i.items;for(var r=0;r<itemElements.length;r++)this._items.push(itemElements[r]);this.propagate("rssload",this),this.outPropertyChange()}else this.propagate("rssloaderror","document null.")}),t.bind("loaderror",this,function(t){this.propagate("rssloaderror")}),t.send()}},e.extendClass(_,l);e.defineClassProperties(_,{url:{set:function(t){e.isString(t)&&(this._url=t,this._xhr.url=t)}},rss:{get:function(){return this._rss}}}),t.GoogleSearch=r,t.URL=n,t.RSSFeed=l,t.RSSRequester=_,Object.defineProperty(t,"__esModule",{value:!0})});